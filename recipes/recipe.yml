---
# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json
name: silvercachy
description: Silverblue image based on BlueBuild's base images with CachyOS kernel and Nvidia
base-image: ghcr.io/blue-build/base-images/fedora-silverblue
image-version: 43

modules:
  # Copy necessary system files
  - type: files
    files:
      - source: system
        destination: /

  # Set up the base image apps/tools
  - type: dnf
    remove:
      auto-remove: true
      packages:
        - firefox
        - firefox-langpacks
        - htop
        - nvtop
        - gnome-software
        - gnome-tour
        - ptyxis
        - gnome-system-monitor
        - malcontent-control
        - gnome-disk-utility
        - gnome-color-manager
        - yelp
        - gnome-shell-extension-background-logo
    install:
      skip-unavailable: true
      packages:
        - gamemode
        - adw-gtk3-theme

  # Install AppIndicator and KStatusNotifierItem Gnome Shell extension
  - type: gnome-extensions
    install:
      - 615 

  # Expose audio group to users
  - type: script
    snippets:
      - 'grep -E "^audio:" /usr/lib/group >> /etc/group'

  # Install CachyOS kernel and addons
  - from-file: cachyos.yml
  
  # Install Nvidia modules and userspace
  - from-file: nvidia.yml

  # Needed services
  - type: systemd
    system:
      enabled:
        - podman.socket                 # needed for flatpaks to access toolbox containers
        - flatpak-firstboot.service     # installs the default flatpaks
        - hostname-firstboot.service    # sets static hostname to silvercachy
        - mok-enroll-firstboot.service  # enrolls kernel and modules signing key for secureboot

  # Sign kernel and modules recursively
  - type: script
    env:
      CERT: /usr/share/silvercachy/MOK.pem
      KEY: /tmp/certs/MOK.priv
    secrets:
      - type: file
        source: ./MOK.priv
        mount: 
          type: file
          destination: /tmp/certs/MOK.priv
    scripts:
      - sign.sh

  # Re-build initramfs
  - type: script
    scripts:
      - initramfs.sh

  # Set OS name
  - type: os-release
    properties:
      ID: silvercachy
      ID_LIKE: fedora
      NAME: SilverCachy
      PRETTY_NAME: SilverCachy - Fedora Silverblue with CachyOS Kernel

  # Sign container image
  - type: signing
